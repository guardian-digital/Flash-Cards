#!/usr/bin/env node

/**
 * Agent Handoff Generator
 * 
 * Generates docs/AGENT_STATUS.md with current project context for agent handoffs.
 * Run this at the end of each session to keep the next agent informed.
 */

import { readFileSync, writeFileSync, existsSync } from 'fs';
import { execSync } from 'child_process';

const PROJECT_ROOT = process.cwd();
const STATUS_FILE = `${PROJECT_ROOT}/docs/AGENT_STATUS.md`;
const PACKAGE_JSON = `${PROJECT_ROOT}/package.json`;
const README = `${PROJECT_ROOT}/README.md`;

// Get git info
function getGitInfo() {
  try {
    const branch = execSync('git rev-parse --abbrev-ref HEAD', { encoding: 'utf-8' }).trim();
    const lastCommit = execSync('git log -1 --pretty=format:"%h - %s (%an, %ar)"', { encoding: 'utf-8' }).trim();
    const uncommitted = execSync('git status --porcelain', { encoding: 'utf-8' }).trim();
    return { branch, lastCommit, hasUncommitted: uncommitted.length > 0 };
  } catch (e) {
    return { branch: 'unknown', lastCommit: 'unknown', hasUncommitted: false };
  }
}

// Get package.json info
function getPackageInfo() {
  try {
    const pkg = JSON.parse(readFileSync(PACKAGE_JSON, 'utf-8'));
    return {
      name: pkg.name,
      version: pkg.version,
      scripts: Object.keys(pkg.scripts || {}),
    };
  } catch (e) {
    return { name: 'unknown', version: 'unknown', scripts: [] };
  }
}

// Get recent file changes
function getRecentChanges() {
  try {
    const changes = execSync('git log --oneline -10', { encoding: 'utf-8' }).trim();
    return changes.split('\n').slice(0, 10);
  } catch (e) {
    return ['Unable to fetch recent changes'];
  }
}

// Get current status
function getCurrentStatus() {
  const gitInfo = getGitInfo();
  const pkgInfo = getPackageInfo();
  const recentChanges = getRecentChanges();
  const timestamp = new Date().toISOString();

  return {
    timestamp,
    gitInfo,
    pkgInfo,
    recentChanges,
  };
}

// Generate status markdown
function generateStatusMarkdown(status) {
  const { timestamp, gitInfo, pkgInfo, recentChanges } = status;

  return `# Flash-Cards â€” Agent Status Dashboard

**Last Updated**: ${timestamp}

> **âš ï¸ Important**: This file is auto-generated by \`scripts/generate-agent-handoff.mjs\`.  
> Run \`pnpm run handoff:generate\` at the end of your session to update it.

---

## ğŸ“Š Current Status

### Git Status
- **Branch**: \`${gitInfo.branch}\`
- **Last Commit**: ${gitInfo.lastCommit}
- **Uncommitted Changes**: ${gitInfo.hasUncommitted ? 'âš ï¸ **Yes** â€” Review before starting' : 'âœ… None'}

### Project Info
- **Name**: ${pkgInfo.name}
- **Version**: ${pkgInfo.version}
- **Available Scripts**: ${pkgInfo.scripts.length} commands

### Recent Changes (Last 10 Commits)
\`\`\`
${recentChanges.join('\n')}
\`\`\`

---

## ğŸ¯ Quick Start

1. **Read**: \`!!! START HERE - READ FIRST.md\` (root directory)
2. **Review**: \`docs/AGENT_ONBOARDING_PROTOCOL.md\` for full onboarding
3. **Check**: \`docs/Standards.md\` for coding standards
4. **Run**: \`pnpm install && pnpm dev\`

---

## ğŸ“ Key Files

- **Onboarding**: \`!!! START HERE - READ FIRST.md\` (root)
- **Protocol**: \`docs/AGENT_ONBOARDING_PROTOCOL.md\`
- **Standards**: \`docs/Standards.md\`
- **Requirements**: \`docs/PRD.md\`
- **Contributing**: \`CONTRIBUTING.md\`

---

## ğŸ”§ Available Commands

\`\`\`bash
${pkgInfo.scripts.map(s => `pnpm ${s}`).join('\n')}
\`\`\`

---

## âš ï¸ Important Notes

### Dual Deployment
- **Next.js App**: \`pages/index.tsx\`, \`components/\`
- **Single-File**: \`index.html\`, \`app.js\` (GitHub Pages)
- **Sync Required**: After changing \`lib/data.ts\`, run \`node scripts/sync-decks.js\`

### Brand Tokens
- Always use \`BRAND\` from \`config/brand.ts\`
- Company: **Scottsdale Cart Tours**

### Audio System
- Pre-generated MP3s in \`audio/\` directory
- Fallback to SpeechSynthesis API
- Generate: \`pnpm run generate-audio\` (requires \`.env\` with \`ELEVENLABS_API_KEY\`)

### Testing
- Unit tests: \`pnpm test\`
- E2E tests: \`pnpm test:e2e\`
- All tests: \`pnpm test:all\`

---

## ğŸš¨ Before You Start

${gitInfo.hasUncommitted ? 'âš ï¸ **There are uncommitted changes.** Review them first:\n```bash\ngit status\ngit diff\n```' : 'âœ… **Working directory is clean.**'}

---

## ğŸ“ Next Steps

1. Review recent commits above to understand recent work
2. Check \`docs/PRD.md\` for product requirements
3. Review \`docs/Standards.md\` for coding standards
4. Start with \`pnpm dev\` to see the app running

---

**Generated by**: \`scripts/generate-agent-handoff.mjs\`  
**Run**: \`pnpm run handoff:generate\` to update this file
`;
}

// Main execution
try {
  console.log('ğŸ”„ Generating agent handoff status...');
  
  const status = getCurrentStatus();
  const markdown = generateStatusMarkdown(status);
  
  writeFileSync(STATUS_FILE, markdown, 'utf-8');
  
  console.log('âœ… Generated:', STATUS_FILE);
  console.log('ğŸ“Š Status:', status.gitInfo.hasUncommitted ? 'âš ï¸  Uncommitted changes detected' : 'âœ… Clean working directory');
  console.log('ğŸ“ Last commit:', status.gitInfo.lastCommit);
} catch (error) {
  console.error('âŒ Error generating handoff:', error.message);
  process.exit(1);
}

